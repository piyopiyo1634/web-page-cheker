name: web-page-checker

on:
  workflow_dispatch:
  schedule:
    - cron: "0 * * * *"   # æ¯æ™‚0åˆ†ã«å®Ÿè¡Œï¼ˆã‚ã¨ã§å¤‰æ›´OKï¼‰

jobs:
  check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0    # çœç•¥ã—ã¦ã‚‚ã„ã„ã‘ã©ã€å±¥æ­´å–ã£ã¦ãŠããªã‚‰ã“ã‚Œ
          
      - name: Setup Node              # â˜…è¿½åŠ 1: Nodeã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ï¼ˆCheckoutã®ã™ãä¸‹ï¼‰
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Install deps            # â˜…è¿½åŠ 2: package.json ã®ä¾å­˜ã‚’å…¥ã‚Œã‚‹
        run: npm install

      - name: Fetch & normalize current page   # â˜…è¿½åŠ 3: curl ã®ä»£ã‚ã‚Šã« normalize_html.js ã‚’ä½¿ã†
        run: |
          mkdir -p snapshots
          node normalize_html.js "https://bk-japan.myshopify.com/" > snapshots/current_test.html
          head -n 5 snapshots/current_test.html
      
      - name: Compare snapshot
        id: diff
        run: |
          echo "===== diff start ====="
          if [ ! -f snapshots/last_test.html ]; then
            echo "No previous snapshot."
            cp snapshots/current_test.html snapshots/last_test.html
            echo "changed=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          diff_result=$(diff -q snapshots/current_test.html snapshots/last_test.html || true)
          echo "diff_result=$diff_result"
          if [ -z "$diff_result" ]; then
            echo "No change detected."
            echo "changed=false" >> "$GITHUB_OUTPUT"
          else
            echo "Change detected!"
            echo "changed=true" >> "$GITHUB_OUTPUT"
          fi
      - name: Save & Commit if changed
        if: steps.diff.outputs.changed == 'true'
        run: |
          cp snapshots/current_test.html snapshots/last_test.html

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # æœ€æ–° main ã‚’å–å¾—ï¼ˆfast-forward onlyï¼‰
          git fetch origin main
          git merge --ff-only origin/main || true

          git add snapshots/last_test.html
          git commit -m "Update snapshot" || true

          # push ãŒ race condition ã§å¤±æ•—ã—ã¦ã‚‚ç„¡è¦–
          git push origin HEAD:main || echo "Push failed, but continue."
      - name: Send LINE notification
        if: steps.diff.outputs.changed == 'true'
        env:
          LINE_ACCESS_TOKEN: ${{ secrets.LINE_ACCESS_TOKEN }}
          LINE_USER_IDS: ${{ secrets.LINE_USER_IDS }}
        run: |
          IFS=',' read -ra IDS <<< "$LINE_USER_IDS"
          for ID in "${IDS[@]}"; do
            curl -X POST https://api.line.me/v2/bot/message/push \
              -H "Authorization: Bearer ${LINE_ACCESS_TOKEN}" \
              -H "Content-Type: application/json" \
              -d "{
                \"to\": \"${ID}\",
                \"messages\": [
                  {
                    \"type\": \"text\",
                    \"text\": \"æˆ¦ã ï¼ï¼ğŸ”¥\\nhttps://bk-japan.myshopify.com/\"
                  }
                ]
              }"
          done

      - name: Show result
        run: echo "changed = ${{ steps.diff.outputs.changed }}"
